name: Deploy to Cloud Foundry

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'Deployment target'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - main_api
          - mule_api
          - boomi_api
          - gemma_api
          - frontend

env:
  CF_API: https://api.cf.eu10-005.hana.ondemand.com
  CF_ORG: ${{ secrets.CF_ORG }}
  CF_SPACE: ${{ secrets.CF_SPACE }}
  DEPLOY_TARGET: ${{ github.event.inputs.deploy_target || 'all' }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install CF CLI
        run: |
          wget -qO- https://packages.cloudfoundry.org/stable?release=linux64-binary | tar -xz
          sudo mv cf /usr/local/bin/cf
          cf version

      - name: Login to Cloud Foundry
        env:
          CF_USERNAME: ${{ secrets.CF_USERNAME }}
          CF_PASSWORD: ${{ secrets.CF_PASSWORD }}
        run: |
          cf login -a "$CF_API" -u "$CF_USERNAME" -p "$CF_PASSWORD" -o "$CF_ORG" -s "$CF_SPACE"

      # Build Frontend-Pro with Vite env (compile-time)
      - name: Build Frontend Pro (Vite)
        if: env.DEPLOY_TARGET == 'all' || env.DEPLOY_TARGET == 'frontend'
        working-directory: IFA-Project/frontend-pro
        env:
          VITE_MAIN_API_PROTOCOL: ${{ secrets.MAIN_API_PROTOCOL }}
          VITE_MAIN_API_HOST: ${{ secrets.MAIN_API_HOST }}
          VITE_IFLOW_API_PROTOCOL: ${{ secrets.IFLOW_API_PROTOCOL }}
          VITE_IFLOW_API_HOST: ${{ secrets.IFLOW_API_HOST }}
          VITE_BOOMI_API_URL: ${{ secrets.BOOMI_API_URL }}
          VITE_IFLOW_API_URL: ${{ secrets.IFLOW_API_URL }}
          VITE_GEMMA3_API_URL: ${{ secrets.GEMMA3_API_URL }}
          VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          npm ci
          npm run build

      # Push Main API
      - name: Push Main API
        if: env.DEPLOY_TARGET == 'all' || env.DEPLOY_TARGET == 'main_api'
        working-directory: app
        run: cf push it-resonance-main-api -f manifest.yml

      # Push BoomiToIS API
      - name: Push BoomiToIS API
        if: env.DEPLOY_TARGET == 'all' || env.DEPLOY_TARGET == 'boomi_api'
        working-directory: BoomiToIS-API
        run: cf push boomi-to-is-api -f manifest.yml

      # Push MuleToIS API
      - name: Push MuleToIS API
        if: env.DEPLOY_TARGET == 'all' || env.DEPLOY_TARGET == 'mule_api'
        working-directory: MuleToIS-API
        run: cf push mule-to-is-api -f manifest.yml

      # Push Gemma3 API (optional)
      - name: Push Gemma3 API
        if: env.DEPLOY_TARGET == 'all' || env.DEPLOY_TARGET == 'gemma_api'
        working-directory: MuleToIS-API-Gemma3
        run: cf push mulesoft-iflow-api-gemma3 -f manifest.yml

      # Push Frontend-Pro (Staticfile buildpack) using built dist/
      - name: Push Frontend Pro
        if: env.DEPLOY_TARGET == 'all' || env.DEPLOY_TARGET == 'frontend'
        working-directory: IFA-Project/frontend-pro
        run: cf push ifa-frontend-pro -p dist -b staticfile_buildpack

      # Set runtime env across apps via Python helper (uses Secrets)
      - name: Apply CF runtime env and restage
        env:
          # Common
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

          # Main API (runtime)
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_ENABLE_DOCUMENTS: 'false'
          BOOMI_API_URL: ${{ secrets.BOOMI_API_URL }}
          MULE_API_URL: ${{ secrets.MULE_API_URL }}
          GEMMA3_API_URL: ${{ secrets.GEMMA3_API_URL }}
          DATABASE_ENABLED: 'true'

          # Boomi/Mule/Gemma (runtime)
          MAIN_API_URL: ${{ secrets.MAIN_API_URL }}
          SAP_BTP_TENANT_URL: ${{ secrets.SAP_BTP_TENANT_URL }}
          SAP_BTP_CLIENT_ID: ${{ secrets.SAP_BTP_CLIENT_ID }}
          SAP_BTP_CLIENT_SECRET: ${{ secrets.SAP_BTP_CLIENT_SECRET }}
          SAP_BTP_OAUTH_URL: ${{ secrets.SAP_BTP_OAUTH_URL }}
          SAP_BTP_DEFAULT_PACKAGE: ${{ secrets.SAP_BTP_DEFAULT_PACKAGE }}
        run: |
          python ci-cd-deployment/scripts/set_cf_credentials.py --restage

      # Verify deployments
      - name: Verify API health
        if: env.DEPLOY_TARGET == 'all' || env.DEPLOY_TARGET == 'main_api'
        run: curl -f "${{ secrets.MAIN_API_URL }}/api/health"

      - name: Verify Mule API health
        if: env.DEPLOY_TARGET == 'all' || env.DEPLOY_TARGET == 'mule_api'
        run: curl -f "${{ secrets.MULE_API_URL }}/health"

      - name: Verify Boomi API health
        if: env.DEPLOY_TARGET == 'all' || env.DEPLOY_TARGET == 'boomi_api'
        run: curl -f "${{ secrets.BOOMI_API_URL }}/health"

      - name: Success notification
        if: success()
        run: |
          echo "✅ Deployment successful."
          echo "Frontend Pro deployed (if selected). APIs restaged with runtime env."

      - name: Failure notification
        if: failure()
        run: |
          echo "❌ Deployment failed. Check logs above."
