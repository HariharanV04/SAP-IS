# MuleToIFlow GenAI Approach

**Date: May 12, 2025**

## Project Overview

This project aims to generate SAP Integration Suite iFlow XML files from markdown API specifications using a combination of template-based generation and GenAI (Claude). The goal is to create valid iFlow files that include all necessary components like RequestReply, ExceptionHandler, Logger, etc., with proper element definitions and flow connections.

## Key Components

The project uses a hybrid approach:
1. **GenAI Analysis**: Claude analyzes markdown API specifications to extract components, endpoints, and connections
2. **JSON Intermediate Representation**: The analysis is converted to a structured JSON format
3. **Template-Based Generation**: Templates are used to generate the actual iFlow XML
4. **Validation & Fallback**: Validation ensures all referenced components exist, with fallback mechanisms for missing components

## Files and Structure

### Main Scripts

- **generate_iflow_with_genai.py**: Entry point script that reads markdown files and initiates the generation process
- **enhanced_genai_iflow_generator.py**: Core implementation of the iFlow generation logic
- **enhanced_iflow_templates.py**: Templates for various iFlow components (XML snippets)

### Input/Output Files

- **Input**: Markdown files describing API specifications (e.g., `product_api_test_explicit.md`)
- **Output**: 
  - ZIP files containing iFlow artifacts
  - Debug files in the `genai_debug` directory

### Debug Files

The following debug files are generated in the `genai_debug` directory:
- `raw_analysis_response.txt`: Raw response from Claude's API analysis
- `parsed_components.json`: Parsed JSON structure after extracting from Claude's response
- `final_components.json`: Final JSON structure after adding missing components
- `iflow_input_components_{iflow_name}.json`: JSON used to generate the iFlow XML
- `final_iflow_{iflow_name}.xml`: Final generated iFlow XML
- `raw_description_{iflow_name}.txt`: Raw description generated by Claude

## How It Works

1. **Markdown Analysis**:
   - The markdown content is sent to Claude with a prompt asking it to analyze the API structure
   - Claude returns a JSON structure describing the API endpoints, components, and connections

2. **JSON Processing**:
   - The JSON is parsed and validated
   - Missing components are added
   - Transformation scripts are generated if needed

3. **iFlow Generation**:
   - Templates are used to generate XML for each component
   - Components are connected based on the specified connections
   - Validation ensures all referenced components exist
   - Missing components are automatically added

4. **Output Creation**:
   - The generated XML and other required files are packaged into a ZIP file
   - Debug files are saved for troubleshooting

## Recent Improvements

1. **Fixed Process Content Placeholder**: Added code to ensure the `{process_content}` placeholder is properly replaced
2. **Enhanced Component Type Mapping**: Added support for mapping component types like "logger" to "write_to_log"
3. **Improved Connection Handling**: Added code to process connections and create sequence flows
4. **Added Debug File Generation**: Added code to save JSON and XML at various stages for debugging
5. **Fixed Request-Reply Template**: Updated code to match the template method's signature

## Running the Code

### Prerequisites

- Python 3.7+
- Anthropic API key (for Claude)
- Required Python packages (see requirements.txt)

### Setup

1. Clone the repository
2. Create a `.env` file with your API keys:
   ```
   ANTHROPIC_API_KEY=your_api_key_here
   ```
3. Install required packages:
   ```
   pip install -r requirements.txt
   ```

### Running the Generator

```bash
python generate_iflow_with_genai.py
```

By default, this will:
1. Read the markdown file specified in the script
2. Generate an iFlow based on the markdown content
3. Save the iFlow as a ZIP file in the output directory
4. Save debug files in the `genai_debug` directory

### Command Line Arguments

The script supports the following command line arguments:
- `--input`: Path to the markdown file (default: `product_api_test_explicit.md`)
- `--output`: Output directory for the generated iFlow (default: `output`)
- `--name`: Name of the generated iFlow (default: derived from the markdown filename)

Example:
```bash
python generate_iflow_with_genai.py --input my_api.md --output my_iflows --name MyCustomIFlow
```

## JSON Structure

The intermediate JSON structure has the following format:

```json
{
  "api_name": "Name of the API",
  "base_url": "Base URL of the API",
  "endpoints": [
    {
      "method": "HTTP method (GET, POST, etc.)",
      "path": "Path of the endpoint",
      "purpose": "Purpose of the endpoint",
      "components": [
        {
          "type": "Component type (https_sender, content_modifier, request_reply, etc.)",
          "name": "Component name",
          "id": "Component ID",
          "config": {
            "key1": "value1",
            "key2": "value2"
          }
        }
      ],
      "connections": [
        {
          "source": "Source component name",
          "target": "Target component name"
        }
      ],
      "transformations": [
        {
          "name": "Transformation name",
          "type": "Transformation type (groovy, xslt, etc.)",
          "script": "Script content"
        }
      ]
    }
  ],
  "parameters": [
    {
      "name": "Parameter name",
      "type": "Parameter type",
      "default": "Default value"
    }
  ]
}
```

## Known Issues and Limitations

1. **XML Generation**: Claude sometimes generates invalid XML that fails validation
2. **Component Mapping**: Some component types in the JSON may not map correctly to iFlow components
3. **Complex Flows**: Very complex flows with many components may not be generated correctly

## Future Improvements

1. **Enhanced XML Validation**: Add more robust XML validation and fixing
2. **Better Component Mapping**: Improve mapping between JSON component types and iFlow components
3. **UI Integration**: Add a web UI for easier interaction
4. **More Templates**: Add more templates for different iFlow patterns
5. **Better Error Handling**: Improve error handling and reporting

## Contributors

- Original implementation by the SAP Integration Suite team
- Enhanced with GenAI capabilities by Deepan
